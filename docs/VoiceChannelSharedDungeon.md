# 🎙️ 음성 채널 기반 공유 던전 시스템

## 📋 목차
1. [시스템 개요](#1-시스템-개요)
2. [참여 조건](#2-참여-조건)
3. [알림 계층 시스템](#3-알림-계층-시스템)
4. [만남 이벤트](#4-만남-이벤트)
5. [관전/난입 통합](#5-관전난입-통합)
6. [보상 시스템](#6-보상-시스템)
7. [UI/UX](#7-uiux)
8. [구현 우선순위](#8-구현-우선순위)

---

## 1. 시스템 개요

### 1.1 핵심 컨셉
**"같은 음성 채널 + 같은 던전 = 공유 던전 인스턴스"**

- 각자 독립적으로 탐험하지만 같은 공간을 공유
- 탐험 중 특정 타이밍에 우연히 만남
- 자연스러운 협력/경쟁 유도
- 강제성 없는 멀티플레이어 경험

### 1.2 Journey 스타일 만남
- 각자 독립 탐험 중 우연히 다른 플레이어 발견
- 선택적으로 협력하거나 지나칠 수 있음
- Dark Souls의 환영/메시지 시스템 차용
- MMO 필드 보스 느낌의 공동 컨텐츠

### 1.3 기존 시스템과의 차이점

| 기능 | 기존 | 신규 |
|------|------|------|
| **던전 입장** | 완전 독립 | 반독립 (위치 공유) |
| **전투 알림** | 서버 전체 공개 | 음성 채널 우선 |
| **관전** | 누구나 가능 | 음성 채널 우선 |
| **난입** | 10라운드 이내 | +음성 채널 + 같은 던전 필수 |
| **보상** | 기여도 비례 | +근접도 보너스 |

---

## 2. 참여 조건

### 2.1 공유 인스턴스 참여 조건 ⭐

**필수 조건:**
1. ✅ **같은 음성 채널에 접속**
2. ✅ **같은 던전 선택**

**예시:**
```
음성 채널 "파티방 1"
├─ 플레이어A: 잊혀진 숲 탐험 중 ✅ (공유 인스턴스 A)
├─ 플레이어B: 잊혀진 숲 탐험 중 ✅ (공유 인스턴스 A)
└─ 플레이어C: 불타는 화산 탐험 중 ❌ (독립)

→ A와 B는 서로 만날 수 있음
→ C는 같은 채널이지만 다른 던전이므로 독립
```

### 2.2 인스턴스 생성/참여 규칙

**인스턴스 생성:**
- 같은 음성 채널 + 같은 던전을 선택한 첫 플레이어가 인스턴스 생성
- 이후 같은 조건의 플레이어는 기존 인스턴스에 자동 참여

**인스턴스 식별:**
- 키: `(voice_channel_id, dungeon_id)`
- 예: `(123456789, 1)` → "음성 채널 123456789의 잊혀진 숲 인스턴스"

**참여 알림:**
```
📣 채널 알림
"@플레이어B 님이 같은 던전에 입장했습니다!"
"현재 탐험 중: 2명"
```

### 2.3 탈퇴 조건

**자동 탈퇴:**
- 음성 채널 퇴장
- 던전 종료 (클리어/사망/귀환)
- 세션 타임아웃

**탈퇴 알림:**
```
"@플레이어A 님이 던전을 떠났습니다."
"현재 탐험 중: 1명"
```

---

## 3. 알림 계층 시스템

### 3.1 알림 레벨 정의

**Level 1: 즉시 알림 (최우선)**
- 조건: 같은 VC + 같은 던전 + 근처 스텝 (±3)
- 타이밍: 즉시
- 메시지: "⚔️ **근처에서 전투 소리가 들린다!**"
- 버튼: [🏃 달려가기] [👁️ 관전하기] [🚶 무시하기]

**Level 2: 같은 채널 알림**
- 조건: 같은 VC + 같은 던전 + 먼 스텝
- 타이밍: 5초 후
- 메시지: "⚔️ 채널 어딘가에서 전투 중..."
- 버튼: [🔍 찾아가기] [👁️ 관전하기]

**Level 3: 서버 알림 (옵션)**
- 조건: 다른 VC 또는 다른 던전
- 타이밍: 15초 후
- 메시지: "⚔️ 누군가 전투 중 (다른 지역)"
- 버튼: [👁️ 관전하기] (난입 불가)

### 3.2 알림 우선순위 표

| 상황 | 같은 VC | 같은 던전 | 근처 스텝 | 알림 | 난입 | 관전 |
|------|---------|-----------|-----------|------|------|------|
| **A** | ✅ | ✅ | ✅ | 즉시 | ✅ 무료 | ✅ 즉시 |
| **B** | ✅ | ✅ | ❌ | 5초 | ✅ 100G | ✅ 즉시 |
| **C** | ✅ | ❌ | - | 없음 | ❌ | ❌ |
| **D** | ❌ | - | - | 15초 | ❌ | ✅ 5초 지연 |

### 3.3 알림 UI 예시

**Level 1 (즉시):**
```
┌─────────────────────────────────┐
│ ⚔️ 근처에서 전투 소리가 들린다! │
├─────────────────────────────────┤
│ 👤 임용헌 님이 전투 중입니다.  │
│ 🗺️ 던전: 잊혀진 숲             │
│ 📍 위치: 약 2걸음 거리          │
│ 👹 상대: 화염 골렘 (보통)      │
│ ⏰ 라운드: 2/10                 │
├─────────────────────────────────┤
│ [🏃 달려가기] - 즉시 난입       │
│ [👁️ 관전하기] - 실시간 관전    │
│ [🚶 무시하기]                   │
└─────────────────────────────────┘
```

**Level 2 (원거리):**
```
┌─────────────────────────────────┐
│ ⚔️ 채널 어딘가에서 전투 중...  │
├─────────────────────────────────┤
│ 👤 임용헌 님이 전투 중          │
│ 🗺️ 던전: 잊혀진 숲             │
│ 📍 위치: 약 15걸음 거리         │
│ 💰 난입 비용: 100 G             │
├─────────────────────────────────┤
│ [🔍 찾아가기] - 100G (보상 90%) │
│ [👁️ 관전하기]                   │
└─────────────────────────────────┘
```

---

## 4. 만남 이벤트

### 4.1 발생 조건

**기본 조건:**
- 같은 음성 채널 ✅
- 같은 던전 ✅
- 근처 스텝 (±2) ✅
- 확률: 20%

**트리거 타이밍:**
- 탐험 스텝 진행 시마다 체크
- 전투 시작 시
- 특정 이벤트 발생 시

### 4.2 이벤트 종류

#### 4.2.1 교차로 만남 (30% 확률)

**설명:**
- 탐험 중 다른 플레이어와 우연히 마주침
- 양쪽 모두 선택 가능

**선택지:**
```
[🔍 찾아가기] - 만남 성립
[🚶 그냥 지나치기] - 만남 취소
```

**만남 성립 시:**
```
┌─────────────────────────────────┐
│ 🤝 만남                         │
├─────────────────────────────────┤
│ @플레이어A 와 @플레이어B 가    │
│ 교차로에서 만났다!              │
├─────────────────────────────────┤
│ [🤝 같이 가기] - 다음 전투 파티│
│ [💬 대화하기] - 버프 교환       │
│ [💰 거래하기] - 아이템 교환     │
│ [👋 헤어지기] - 각자 탐험       │
└─────────────────────────────────┘
```

#### 4.2.2 캠프파이어 (25% 확률)

**설명:**
- 던전 중간에 휴식 지점 발견
- 같은 채널의 근처 플레이어들에게 알림
- 여럿이 쉬면 효과 증가

**휴식 효과:**

| 참여 인원 | HP 회복 | 버프 | 소요 시간 |
|-----------|---------|------|-----------|
| 1명 | 30% | 없음 | 10초 |
| 2명 | 40% | 공격력 +10% (1전투) | 5초 |
| 3명 이상 | 50% | 공격력 +10% (2전투) | 5초 |

**캠프파이어 메뉴:**
```
[💬 정보 교환] - 팁 공유 → 소량 경험치
[🎁 선물 주기] - 소비템 증정
[🤝 파티 신청] - 다음 N개 전투 협력
[📜 메시지 남기기] - 다른 사람에게 메모
```

#### 4.2.3 동시 조우 (20% 확률)

**설명:**
- 같은 타이밍에 전투 시작
- 협력 또는 경쟁 선택

**협력 모드:**
- 둘 다 [합류] 선택 시
- 즉시 멀티플레이어 전투
- 보상: 기여도 비례 + 협력 보너스 +20%

**경쟁 모드:**
- 둘 다 [경쟁] 선택 시
- 각자 별도 전투 (같은 몬스터 종류)
- 먼저 처치한 사람이 승리
- 승자: 보상 150%
- 패자: 보상 50%
- 서로의 진행도 실시간 표시

**경쟁 UI:**
```
┌─────────────────────────┐
│ ⚔️ 경쟁 전투            │
├─────────────────────────┤
│ 👤 나                   │
│ ❤️ HP: 80%              │
│ 👹 몬스터: 45% ⭐      │
├─────────────────────────┤
│ 👤 상대방               │
│ ❤️ HP: 65%              │
│ 👹 몬스터: 50%         │
└─────────────────────────┘
```

#### 4.2.4 보스방 대기실 (15% 확률)

**설명:**
- 보스 인카운터 시 즉시 시작하지 않음
- 1분간 대기실 생성
- 같은 채널 + 같은 던전 플레이어들에게 알림

**대기실 규칙:**
- 최대 3명까지 참여 가능
- 60초 타임아웃
- 모두 준비 완료 시 즉시 시작

**대기실 UI:**
```
┌─────────────────────────────┐
│ 🚪 보스방 대기실            │
├─────────────────────────────┤
│ 👤 @플레이어1 ✅ 준비 완료  │
│ 👤 @플레이어2 ⏳ 대기 중    │
│ 👤 @플레이어3 ⏳ 대기 중    │
├─────────────────────────────┤
│ ⏰ 남은 시간: 42초           │
│ 👹 보스: 화염의 드래곤      │
│ 💀 난이도: ★★★★☆          │
├─────────────────────────────┤
│ [🚪 대기실 입장]            │
│ [✅ 준비 완료]              │
│ [⏭️ 혼자 도전]              │
│ [🚶 포기하고 나가기]        │
└─────────────────────────────┘
```

#### 4.2.5 위기 목격 (10% 확률)

**설명:**
- 근처 플레이어가 위험한 상황 (HP < 30%)
- 자연스러운 난입 유도
- 구조 시 보너스

**위기 알림:**
```
┌─────────────────────────────┐
│ 🆘 위기 상황!               │
├─────────────────────────────┤
│ 근처에서 비명 소리가 들린다!│
│                             │
│ 👤 @임용헌 님이 위험에 처함 │
│ 💀 위험도: ★★★☆☆          │
│ 📍 거리: 약 2걸음            │
├─────────────────────────────┤
│ [🏃 달려가기] - 즉시 난입   │
│ [📣 응원하기] - 약간의 버프 │
│ [🚶 지나치기]               │
└─────────────────────────────┘
```

**구조 보상:**
- 구조자: 보상 30% + 영웅 칭호
- 피구조자: 보상 70%

**응원 효과:**
- 대상에게 공격력 +5 (1턴) 버프
- 구조자는 보상 없음

---

## 5. 관전/난입 통합

### 5.1 난입 조건 통합

**기존 조건:**
- ✅ 10라운드 이내
- ✅ 최대 3인 파티
- ✅ 쿨타임 5분

**신규 조건 추가:**
- ✅ **같은 음성 채널**
- ✅ **같은 던전**
- ✅ 근접도 체크 (보너스)

### 5.2 난입 타입별 차이

| 타입 | 조건 | 비용 | 보상 | 설명 |
|------|------|------|------|------|
| **근접 난입** | VC ✅ 던전 ✅ 스텝±3 | 무료 | 100% | 이상적 |
| **원거리 난입** | VC ✅ 던전 ✅ 스텝±10 | 100G | 90% | 약간 페널티 |
| **장거리 난입** | VC ✅ 던전 ✅ 스텝>10 | 500G | 80% | 큰 페널티 |
| **불가능** | VC ❌ 또는 던전 ❌ | - | - | 난입 불가 |

### 5.3 관전 조건 통합

**즉시 관전 (실시간):**
- 같은 음성 채널 ✅
- 같은 던전 ✅
- 지연 없음

**지연 관전:**
- 다른 음성 채널 또는 다른 던전
- 5초 지연
- 음질/화질 저하 (연출)

### 5.4 난입 불가 사유

```
❌ "음성 채널에 접속해야 난입할 수 있습니다"
❌ "같은 음성 채널에 있어야 난입할 수 있습니다"
❌ "같은 던전을 선택한 플레이어만 난입할 수 있습니다"
❌ "난입 시간이 지났습니다 (10라운드 초과)"
❌ "파티가 가득 찼습니다"
❌ "난입 쿨타임 중입니다 (N초 남음)"
```

---

## 6. 보상 시스템

### 6.1 보상 배율 계산

**기본 배율:**
- 기여도 비례 (기존)
- 데미지 + 치유량 기준

**근접도 보너스 (신규):**
- 근접 난입 (±3 스텝): +10%
- 원거리 난입 (±10 스텝): 정상
- 장거리 난입 (>10 스텝): -20%

**캐리 방지 페널티 (기존):**
- 레벨 차 15 이상: 0%
- 레벨 차 10~14: 5%
- 레벨 차 5~9: 20%
- 레벨 차 0~4: 100%

### 6.2 특별 보너스

**구조 보너스:**
- 위기 상황 구조: +20%
- 영웅 포인트 획득

**채널 레벨 보너스:**
- 채널 레벨당 +5%
- 같은 채널에서 오래 플레이할수록 상승
- 일일 리셋

**캠프파이어 보너스:**
- 최근 휴식: +10% (1시간 유지)

**협력 보너스:**
- 동시 조우 협력 모드: +20%

### 6.3 보상 분배 예시

**시나리오:**
```
전투 승리
- 총 보상: 1000 EXP, 500 G
- 참가자: 리더(Lv.10), 난입자A(Lv.12), 난입자B(Lv.8)

기여도:
- 리더: 40% (데미지 4000)
- 난입자A: 35% (데미지 3500, 근접 난입 +10%)
- 난입자B: 25% (데미지 2500)
```

**계산 결과:**
```
👤 리더
   기여도: 40%
   최종: ⭐ +400 EXP │ 💰 +200 G

👤 난입자A (Lv.12)
   기여도: 35%
   근접 보너스: +10%
   캐리 페널티: -20% (레벨 차 2)
   최종: ⭐ +308 EXP │ 💰 +154 G

👤 난입자B (Lv.8)
   기여도: 25%
   최종: ⭐ +250 EXP │ 💰 +125 G
```

---

## 7. UI/UX

### 7.1 채널 상태 표시

**음성 채널 대시보드:**
```
┌─────────────────────────────────┐
│ 🎙️ 파티방 1 - 채널 현황        │
├─────────────────────────────────┤
│ 🗺️ 던전별 현황                 │
│                                 │
│ 📗 잊혀진 숲                    │
│   🚶 탐험 중: 2명               │
│   ⚔️ 전투 중: 1명               │
│                                 │
│ 🔥 불타는 화산                  │
│   🚶 탐험 중: 1명               │
│   ⚔️ 전투 중: 0명               │
├─────────────────────────────────┤
│ 🎚️ 채널 레벨: Lv.3             │
│ 📊 오늘의 통계                  │
│   👹 처치: 142마리               │
│   💰 획득: 15,234 G              │
│   🏆 MVP: @임용헌 (45,123 dmg) │
└─────────────────────────────────┘
```

### 7.2 근처 플레이어 표시

**명령어:** `/근처`

**출력:**
```
┌─────────────────────────────────┐
│ 👥 근처 탐험가 (잊혀진 숲)     │
├─────────────────────────────────┤
│ 🚶 @홍석훈                      │
│    📍 약 1걸음 거리 · 탐험 중  │
│                                 │
│ ⚔️ @임용헌                      │
│    📍 약 3걸음 거리 · 전투 중  │
│    👹 화염 골렘 vs              │
│                                 │
│ 🚶 @김철수                      │
│    📍 약 5걸음 거리 · 휴식 중  │
│    🔥 캠프파이어                │
└─────────────────────────────────┘
```

### 7.3 만남 이력

**명령어:** `/만남이력`

**출력:**
```
┌─────────────────────────────────┐
│ 📜 오늘의 만남 이력             │
├─────────────────────────────────┤
│ 🤝 교차로 만남                  │
│    @홍석훈 님과 만남            │
│    → 같이 전투 (승리)           │
│    ⏰ 30분 전                    │
│                                 │
│ 🆘 위기 구조                    │
│    @임용헌 님 구조              │
│    → 영웅 포인트 +1             │
│    ⏰ 1시간 전                   │
│                                 │
│ 🔥 캠프파이어                   │
│    @김철수, @박영희 님과 휴식  │
│    → 버프 획득                  │
│    ⏰ 2시간 전                   │
└─────────────────────────────────┘
```

### 7.4 채널 레벨 시스템

**경험치 획득:**
- 같은 채널에서 몬스터 처치: +10 EXP
- 같은 채널에서 협력 전투: +50 EXP
- 만남 이벤트 성공: +30 EXP

**레벨업 효과:**
```
Lv.1 → Lv.2 (100 EXP)
  🎁 경험치 +5%

Lv.2 → Lv.3 (300 EXP)
  🎁 골드 드롭률 +5%

Lv.3 → Lv.4 (600 EXP)
  🎁 레어 아이템 드롭률 +3%

Lv.4 → Lv.5 (1000 EXP)
  🎁 특별 칭호 획득
```

**일일 리셋:**
- 매일 자정 레벨 1로 초기화
- 누적 통계는 유지

---

## 8. 구현 우선순위

### Phase 1: 기반 시스템 (1-2주) 🔴 최우선

**목표:** 음성 채널 + 던전 기반 인스턴스 시스템

1. **VoiceChannelService**
   - 음성 채널 상태 추적
   - 유저 입장/퇴장 감지
   - 근접도 계산 (스텝 기반)

2. **SharedDungeonInstance**
   - 인스턴스 생성/관리
   - 키: `(voice_channel_id, dungeon_id)`
   - 세션 참여/탈퇴
   - 참여자 목록 관리

3. **참여 조건 검증**
   - 같은 음성 채널 체크
   - 같은 던전 체크
   - 입장/퇴장 알림

### Phase 2: 알림 통합 (1주) 🟠 중요

**목표:** 계층적 알림 시스템 구축

4. **NotificationLevel 시스템**
   - 즉시/근처/원거리 레벨 구분
   - 알림 발송 타이밍 조절

5. **난입/관전 조건 통합**
   - 음성 채널 + 던전 조건 추가
   - 보상 배율 조정
   - UI 버튼 변경

6. **UI 개선**
   - 채널 상태 표시
   - 근처 플레이어 표시

### Phase 3: 기본 만남 이벤트 (1-2주) 🟡 보통

**목표:** 핵심 만남 이벤트 구현

7. **교차로 만남**
   - 가장 기본적인 만남
   - 선택지 제공

8. **캠프파이어**
   - 휴식 + 만남
   - 다중 참여 가능

### Phase 4: 고급 만남 이벤트 (2주) 🟢 낮음

**목표:** 재미 요소 추가

9. **동시 조우**
   - 협력/경쟁 모드
   - 경쟁 UI

10. **보스방 대기실**
    - 대기실 시스템
    - 준비 확인

11. **위기 목격**
    - 자연스러운 난입
    - 구조 보상

### Phase 5: 추가 콘텐츠 (2주) 🔵 선택

**목표:** 장기 컨텐츠

12. **환영 시스템**
    - 전투 흔적
    - 간접 만남

13. **메시지 시스템**
    - 위치 기반 메시지
    - 평가 시스템

14. **채널 레벨**
    - 경험치 누적
    - 레벨업 보상

---

## 9. 핵심 규칙 요약 ⭐

### 공유 인스턴스 참여 조건
```
✅ 같은 음성 채널
✅ 같은 던전 선택
```

### 알림 우선순위
```
1순위: 같은 VC + 같은 던전 + 근처 스텝 → 즉시
2순위: 같은 VC + 같은 던전 + 먼 스텝 → 5초 후
3순위: 다른 VC 또는 다른 던전 → 15초 후 (관전만)
```

### 난입 가능 여부
```
✅ 같은 VC + 같은 던전 + 10라운드 이내
❌ 다른 VC
❌ 다른 던전
❌ 10라운드 초과
```

### 보상 배율
```
기본: 기여도 비례
근접 난입: +10%
원거리 난입: -10%
장거리 난입: -20%
구조: +20%
협력: +20%
채널 레벨: 레벨당 +5%
```

---

## 10. FAQ

**Q: 같은 음성 채널이지만 다른 던전을 선택하면?**
A: 완전히 독립된 탐험입니다. 서로 만날 수 없고 알림도 가지 않습니다.

**Q: 탐험 중에 음성 채널을 옮기면?**
A: 기존 공유 인스턴스에서 탈퇴하고, 새 채널의 인스턴스에 참여합니다 (같은 던전인 경우).

**Q: 솔로 플레이어도 만남 이벤트가 발생하나요?**
A: 아니요. 음성 채널에 접속하지 않으면 완전 독립 탐험입니다.

**Q: 보스방 대기실에서 시간이 끝나면?**
A: 대기 중인 사람끼리 자동으로 보스전 시작합니다.

**Q: 경쟁 모드에서 둘 다 패배하면?**
A: 둘 다 일반 사망 처리되며, 경쟁 보상은 없습니다.

**Q: 채널 레벨은 음성 채널별로 다른가요?**
A: 네, 각 음성 채널마다 독립적인 레벨을 가집니다.

---

## 11. 기술 요구사항

### 11.1 새로운 서비스

**VoiceChannelService**
- 음성 채널 상태 추적
- 유저-채널 매핑
- 근접도 계산

**SharedInstanceManager**
- 인스턴스 생성/삭제
- 참여자 관리
- 이벤트 트리거

**EncounterManager**
- 만남 이벤트 생성
- 이벤트 실행
- 응답 처리

**NotificationService**
- 계층적 알림 발송
- 타이밍 제어
- UI 생성

### 11.2 데이터 구조

**SharedDungeonInstance**
```
voice_channel_id: int
dungeon_id: int
user_sessions: dict[user_id, DungeonSession]
channel_level: int
channel_exp: int
```

**EncounterEvent**
```
event_type: str
initiator: User
participants: list[User]
timeout: float
responses: dict[user_id, str]
```

### 11.3 이벤트 리스너

**on_voice_state_update**
- 음성 채널 입장/퇴장 감지
- 인스턴스 참여/탈퇴 처리

**on_dungeon_start**
- 인스턴스 자동 참여
- 채널 알림 전송

**on_combat_start**
- 계층적 알림 발송
- 근접 플레이어 체크

---

## 12. 성공 지표

### 12.1 핵심 지표

**참여율:**
- 목표: 전체 던전 세션 중 30% 이상이 음성 채널 기반

**만남 성공률:**
- 목표: 만남 이벤트 발생 시 50% 이상 성공

**협력 전투 비율:**
- 목표: 전체 전투 중 20% 이상이 멀티플레이어

### 12.2 사용자 만족도

**긍정 피드백:**
- 우연한 만남이 재미있다
- 자연스러운 협력 유도
- 강제성 없는 멀티플레이어

**부정 피드백 예방:**
- 너무 많은 알림 (조절 가능하도록)
- 강제 협력 (선택 가능하도록)
- 불공정한 보상 (기여도 비례)

---

## 13. 향후 확장 가능성

### 13.1 길드 시스템 연계
- 길드 음성 채널 = 길드 던전
- 길드 레벨 보너스
- 길드 이벤트

### 13.2 크로스 던전 이벤트
- 특정 시간대에 던전 벽 붕괴
- 다른 던전의 플레이어와 만남
- 특별 보상

### 13.3 PvP 요소
- 동의 하 PvP 가능
- 보물 쟁탈전
- 듀얼 시스템

---

이 문서는 음성 채널 기반 공유 던전 시스템의 완전한 기획서입니다.
구현 시 Phase 1부터 순차적으로 진행하되, 핵심 규칙(같은 VC + 같은 던전)을 반드시 준수해야 합니다.
